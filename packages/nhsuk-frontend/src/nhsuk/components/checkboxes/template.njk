{# packages/nhsuk-frontend/src/nhsuk/components/checkboxes/template.njk #}
{% from "nhsuk/components/error-message/macro.njk" import errorMessage -%}
{% from "nhsuk/components/fieldset/macro.njk" import fieldset %}
{% from "nhsuk/components/hint/macro.njk" import hint %}
{% from "nhsuk/components/label/macro.njk" import label %}
{% from "nhsuk/macros/attributes.njk" import nhsukAttributes %}

{# If an id 'prefix' is not passed, fall back to name #}
{%- set idPrefix = params.idPrefix if params.idPrefix else params.name -%}

{# Track ids we need to reference with aria-describedby #}
{%- set describedBy = params.describedBy if params.describedBy else "" -%}
{%- if params.fieldset and params.fieldset.describedBy -%}
  {% set describedBy = params.fieldset.describedBy %}
{%- endif -%}

{# Is any item conditional? #}
{% set isConditional = false %}
{% for item in params.items %}
  {% if item.conditional %}
    {% set isConditional = true %}
  {% endif %}
{% endfor %}

{# Capture inner markup so we can optionally nest it in a fieldset #}
{% set innerHtml %}
{% if params.hint %}
  {% set hintId = idPrefix + '-hint' %}
  {% set describedBy = describedBy + ' ' + hintId if describedBy else hintId %}
  {{ hint({
    id: hintId,
    classes: params.hint.classes,
    attributes: params.hint.attributes,
    html: params.hint.html,
    text: params.hint.text
  }) | indent(2) | trim }}
{% endif %}
{% if params.errorMessage %}
  {% set errorId = idPrefix + '-error' %}
  {% set describedBy = describedBy + ' ' + errorId if describedBy else errorId %}
  {{ errorMessage({
    id: errorId,
    classes: params.errorMessage.classes,
    html: params.errorMessage.html,
    text: params.errorMessage.text
  }) | indent(2) | trim }}
{% endif %}
  <div {%- if params.id %} id="{{ params.id }}"{% endif %} class="nhsuk-checkboxes
    {%- if params.classes %} {{ params.classes }}{% endif %}
    {%- if isConditional %} nhsuk-checkboxes--conditional{% endif %}"
    {{- nhsukAttributes(params.attributes) }} data-module="nhsuk-checkboxes">

    {% for item in params.items %}
      {% set id = item.id if item.id else idPrefix + ("-" + loop.index if loop.index > 1 else "") %}
      {% set name = item.name if item.name else params.name %}
      {% set conditionalId = "conditional-" + id %}

      {# safer boolean: true if hint exists with text/html, else false #}
      {% set hasHint = (item.hint and (item.hint.text or item.hint.html)) %}
      {% set itemHintId = id + '-item-hint' %}

      {%- if item.divider %}
        <div class="nhsuk-checkboxes__divider">{{ item.divider }}</div>
      {%- else %}

      {# default logic mirrors GOV.UK/NHS patterns #}
      {% set isChecked = item.checked | default((params.values and (item.value in params.values) and (item.checked != false)), true) %}

      <div class="nhsuk-checkboxes__item">
        <input
          class="nhsuk-checkboxes__input"
          id="{{ id }}"
          name="{{ name }}"
          type="checkbox"
          value="{{ item.value }}"
          {{- " checked" if isChecked }}
          {{- " disabled" if item.disabled }}
          {%- if item.exclusive %} data-checkbox-exclusive{% endif -%}
          {%- if item.exclusiveGroup %} data-checkbox-exclusive-group="{{ item.exclusiveGroup }}"{% endif -%}
          {%- if item.conditional %} aria-controls="{{ conditionalId }}" aria-expanded="{{ 'true' if item.checked else 'false' }}"{% endif -%}
          {%- if hasHint %} aria-describedby="{{ itemHintId }}"{% endif -%}
          {{- nhsukAttributes(item.attributes) }}
        >
        {{ label({
          html: item.html,
          text: item.text,
          classes: 'nhsuk-checkboxes__label' + (item.label and item.label.classes and (' ' + item.label.classes) or ''),
          attributes: item.label and item.label.attributes,
          for: id
        }) | indent(8) | trim }}

        {%- if hasHint %}
        {{ hint({
          id: itemHintId,
          classes: 'nhsuk-checkboxes__hint',
          attributes: item.hint and item.hint.attributes,
          html: item.hint and item.hint.html,
          text: item.hint and item.hint.text
        }) | indent(8) | trim }}
        {%- endif %}
      </div>

      {% if item.conditional %}
      <div class="nhsuk-checkboxes__conditional{% if not isChecked %} nhsuk-checkboxes__conditional--hidden{% endif %}" id="{{ conditionalId }}">
        {{ item.conditional.html | safe }}
      </div>
      {% endif %}

      {% endif %}
    {% endfor %}
  </div>
{% endset %}

<div class="nhsuk-form-group{%- if params.errorMessage %} nhsuk-form-group--error{% endif %}{% if params.formGroup and params.formGroup.classes %} {{ params.formGroup.classes }}{% endif %}"
  {{- nhsukAttributes(params.formGroup and params.formGroup.attributes) }}>
{% if params.fieldset %}
  {% call fieldset({
    describedBy: describedBy,
    classes: params.fieldset.classes,
    attributes: params.fieldset.attributes,
    legend: params.fieldset.legend
  }) %}
  {{ innerHtml | trim | safe }}
  {% endcall %}
{% else %}
  {{ innerHtml | trim | safe }}
{% endif %}
</div>
