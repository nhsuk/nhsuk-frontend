{% from "nhsuk/macros/attributes.njk" import nhsukAttributes %}
{% from "nhsuk/macros/icon.njk" import nhsukIcon %}

{#- Set classes for this component #}
{%- set classNames = "nhsuk-card" -%}
{%- set classNamesHeading = "nhsuk-card__heading" -%}

{%- if params.clickable %}
  {% set classNames = classNames ~ " nhsuk-card--clickable" %}
{% endif %}

{%- if params.feature %}
  {% set classNames = classNames ~ " nhsuk-card--feature" %}
{% endif %}

{%- if params.primary %}
  {% set classNames = classNames ~ " nhsuk-card--primary" %}
{% endif %}

{%- if params.secondary %}
  {% set classNames = classNames ~ " nhsuk-card--secondary" %}
{% endif %}

{%- if params.type %}
  {% set classNames = classNames ~ " nhsuk-card--care nhsuk-card--care--" ~ params.type %}
{% endif %}

{%- if params.classes %}
  {% set classNames = classNames ~ " " ~ params.classes %}
{% endif %}

{%- if params.headingSize and
  params.headingSize in ["xxs", "xs", "s", "m", "l", "xl"] and (
    not params.headingClasses or (
      not "nhsuk-heading-xxs" in params.headingClasses and
      not "nhsuk-heading-xs" in params.headingClasses and
      not "nhsuk-heading-s" in params.headingClasses and
      not "nhsuk-heading-m" in params.headingClasses and
      not "nhsuk-heading-l" in params.headingClasses and
      not "nhsuk-heading-xl" in params.headingClasses
    )
  )
%}
  {% set classNamesHeading = classNamesHeading ~ " nhsuk-heading-" ~ params.headingSize %}
{% endif %}

{%- if params.headingClasses %}
  {% set classNamesHeading = classNamesHeading ~ " " ~ params.headingClasses %}
{% endif %}

{%- set headingLevel = params.headingLevel if params.headingLevel else 2 %}

{%- macro _careHeading(params, classNames) %}
{% if params.heading %}
  <h{{ headingLevel }} class="{{ classNames }}">
  {% if params.href and not params.feature %}
    <a class="nhsuk-card__link" href="{{ params.href }}">
      {{- params.heading | safe -}}
    </a>
  {% else %}
    <span role="text">
      <span class="nhsuk-u-visually-hidden">
        {%- if params.type == "emergency" -%}
          Immediate action required:
        {%- elif params.type == "urgent" -%}
          Urgent advice:
        {%- else -%}
          Non-urgent advice:
        {%- endif -%}
      </span> {{ params.heading }}
    </span>
  {% endif %}
  </h{{ headingLevel }}>
  <span class="nhsuk-card--care__arrow" aria-hidden="true"></span>
{% endif %}
{% if params.headingHtml %}
  {{ params.headingHtml | safe | trim | indent(2) }}
{% endif %}
{% endmacro -%}

{%- macro _cardHeading(params, classNames) %}
{% if params.heading %}
  <h{{ headingLevel }} class="{{ classNames }}">
  {% if params.href and not params.feature %}
    <a class="nhsuk-card__link" href="{{ params.href }}">
      {{- params.heading | safe -}}
    </a>
  {% else %}
    {{ params.heading }}
  {% endif %}
  </h{{ headingLevel }}>
{% endif %}
{% if params.headingHtml %}
  {{ params.headingHtml | safe | trim | indent(2) }}
{% endif %}
{% endmacro -%}

{%- macro _cardAction(action, cardHeading) %}
  <a class="nhsuk-link {%- if action.classes %} {{ action.classes }}{% endif %}" href="{{ action.href }}"
    {{- nhsukAttributes(action.attributes) }}>
    {{- action.html | safe | indent(4) if action.html else action.text -}}
    {%- if action.visuallyHiddenText or cardHeading -%}
    <span class="nhsuk-u-visually-hidden">
      {%- if action.visuallyHiddenText %} {{ action.visuallyHiddenText }}{% endif -%}
      {%- if cardHeading %} ({{ cardHeading }}){% endif -%}
    </span>
    {%- endif -%}
  </a>
{% endmacro -%}

<div {%- if params.id %} id="{{ params.id }}"{% endif %} class="{{ classNames }}"
  {{- nhsukAttributes(params.attributes) }}>
{% if params.imgURL %}
  <img class="nhsuk-card__img" src="{{ params.imgURL }}" alt="{{ params.imgALT }}">
{% endif %}
{% if params.type or params.actions %}
  <div class="nhsuk-card__heading-container">
  {% if params.type %}
    {{ _careHeading(params, classNamesHeading) | trim | indent(2) }}
  {% else %}
    {{ _cardHeading(params, classNamesHeading) | trim | indent(2) }}
  {% endif %}
    {% if params.actions.items.length == 1 %}
    <div class="nhsuk-card__actions {%- if params.actions.classes %} {{ params.actions.classes }}{% endif %}">
      {{ _cardAction(params.actions.items[0], params.heading) | trim | indent(4) }}
    </div>
    {% elif params.actions.items.length %}
    <ul class="nhsuk-card__actions {%- if params.actions.classes %} {{ params.actions.classes }}{% endif %}">
      {% for action in params.actions.items %}
      {% if action %}
      <li class="nhsuk-card__action">
        {{ _cardAction(action, params.heading) | trim | indent(8) }}
      </li>
      {% endif %}
      {% endfor %}
    </ul>
  {% endif %}
  </div>
{% endif %}
  <div class="nhsuk-card__content">
  {% if not params.type and not params.actions %}
    {{ _cardHeading(params, classNamesHeading) | trim | indent(2) }}
  {% endif %}
  {% if caller or params.descriptionHtml %}
    {{ caller() if caller else params.descriptionHtml | safe | trim | indent(4) }}
  {% elif params.description %}
    <p class="nhsuk-card__description">
      {{- params.description -}}
    </p>
  {% endif %}
  {% if params.primary %}
    {{ nhsukIcon("chevron-right-circle") | trim | indent(4) }}
  {% endif %}
  </div>
</div>
